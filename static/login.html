<html lang="en">
<head>
    <title>Login</title>
    <meta name="google-signin-scope" content="email">
    <meta name="google-signin-client_id" content="900696138865-vdsgcariehvat8nkluvltoq79n0rhqr9.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
</head>
<body>

<div class="g-signin2" data-onsuccess="onSignIn" data-theme="light"></div>
<div id='hlc-log' class="hlc-log">

</div>
<script>
    if (!chrome && !chrome.runtime){
        document.body.innerHTML = "only chrome browser is supported.";
    }


    let extensionId = "cdbkmcnjjgdmbgejfejpefefoaacobbg";


    $ = document.getElementById.bind(document);

    var HLC_UID = null;
    var HLC_TOKEN = null;


    function request(method, url, payload, onSuccess, onFail){
        let r = new XMLHttpRequest();
        r.open(method, url, true);
        function onreadystatechange(){
            if (r.readyState === XMLHttpRequest.DONE){
                if (r.status >= 200 && r.status <300 || r.status === 304){
                    onSuccess(r.response);
                } else {
                    onFail(r.status, r.statusText)
                }
            }
        }
        r.onreadystatechange = onreadystatechange;
        r.send(payload);
    }


    function onHLCAuthResponse(resp){
        let suc = false;
        try{
            let respObj = JSON.parse(resp);
            HLC_UID = parseInt(respObj.uid);
            HLC_TOKEN = respObj.token;
            suc = true;
            log("LOG IN SUCCESS " + HLC_UID);
        } catch( e ){
            console.error(e);
            log("ERROR: " + e.toString());
        }
        chrome.runtime.sendMessage(extensionId, {
            login_success: suc,
            hlc_uid: HLC_UID,
            hlc_token: HLC_TOKEN
        }, function(response){
            if (suc){
                window.close();
            }
        });
    }

    function onHLCAuthRespError(code, msg){
        console.error(code, msg);
        log("ERROR: " + msg);
    }

    function doHLCAuth(id_token){
        request("POST", "/google_auth", id_token, onHLCAuthResponse, onHLCAuthRespError)
    }

    function onSignIn(googleUser) {
        // The ID token you need to pass to your backend:
        var id_token = googleUser.getAuthResponse().id_token;
        console.log("ID Token: " + id_token);
        doHLCAuth(id_token);
    }

    function log(text){
        let log = $("hlc-log");
        log.innerText += "\r\n";
        log.innerText += text;
    }
</script>
</body>
</html>